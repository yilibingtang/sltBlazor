@page "/motor"
@using System.Linq
@using Microsoft.EntityFrameworkCore
@using MathNet.Numerics
@using System.Text
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.QuickGrid
@using YX.Models
@inherits MotorBase
@rendermode InteractiveServer
<PageTitle>Motor Management</PageTitle>

<h3>直流减速电机机械特性数据管理系统</h3>
<div class="motor-form">
    @* Page-level alerts *@
    <div>
        <section class="dataset-list">
            <label>已保存数据组</label>
            <div class="dataset-controls">
                @if (SavedMotors == null || SavedMotors.Count == 0)
                {
                    <div>(无已保存数据)</div>
                }
                else
                {
                    <QuickGrid TItem="MotorModel" Items="SavedMotors.AsQueryable()">
                        <PropertyColumn Property="@(m => m.MotorName)" Title="名称" />
                        <PropertyColumn Property="@(m => m.MotorType)" Title="类型" />
                        <PropertyColumn Property="@(m => m.Voltage)" Title="额定电压 (V)" />
                    </QuickGrid>
                }
                <button class="btn" @onclick="NewGroup">新建</button>
                <button class="btn primary" @onclick="SaveGroup">保存</button>
            </div>
        </section>
    </div>
    <section class="basic-info">
        @if (!string.IsNullOrEmpty(PageAlertMessage))
        {
            <div class="alert"
                style="background:@(PageAlertIsError ? "#f8d7da" : "#d4edda");color:@(PageAlertIsError ? "#842029" : "#0f5132");padding:8px;border-radius:4px;margin-bottom:8px;">
                @PageAlertMessage
            </div>
        }
        @if (ValidationErrors != null && ValidationErrors.Count > 0)
        {
            <div class="alert" style="background:#f8d7da;color:#842029;padding:8px;border-radius:4px;margin-bottom:8px;">
                <ul>
                    @foreach (var err in ValidationErrors)
                    {
                        <li>@err</li>
                    }
                </ul>
            </div>
        }
        <EditForm EditContext="editContext" OnValidSubmit="HandleValidSubmit" OnInvalidSubmit="HandleInvalidSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="row">
                <label>电机名称</label>
                <InputText class="form-control" @bind-Value="EditingMotor.MotorName" />
                <ValidationMessage For="() => EditingMotor.MotorName" />
            </div>
            <div class="row">
                <label>电机类型</label>
                <InputSelect @bind-Value="EditingMotor.MotorType">
                    <option value="MotorType.SingleMotor">SingleMotor</option>
                    <option value="MotorType.IntegratedMotor">IntegratedMotor</option>
                </InputSelect>
                <ValidationMessage For="() => EditingMotor.MotorType" />
            </div>
            <div class="row">
                <label>额定电压 (V)</label>
                <InputNumber TValue="double" class="form-control" @bind-Value="EditingMotor.Voltage" />
                <ValidationMessage For="() => EditingMotor.Voltage" />
            </div>
        </EditForm>
    </section>
    <section class="placeholder">
        <p>下面为该电机添加测试数据（扭矩/电流/转速），可增行、保存并进行拟合。</p>
    </section>
    <section class="data-points">
        <h4>测试点 (按行输入)</h4>
        <table class="data-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>扭矩 (Nm)</th>
                    <th>转速 (rpm)</th>
                    <th>电流 (A)</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < EditingPoints.Count; i++)
                {
                    <tr>
                        <td>@(i + 1)</td>
                        <td>
                            <InputNumber TValue="double" @bind-Value="EditingPoints[i].Torque" />
                        </td>
                        <td>
                            <InputNumber TValue="double" @bind-Value="EditingPoints[i].Speed" />
                        </td>
                        <td>
                            <InputNumber TValue="double" @bind-Value="EditingPoints[i].Current" />
                        </td>
                        <td><button class="btn small" @onclick="(() => RemovePoint(i))">删除</button></td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="actions">
            <button class="btn" @onclick="AddPoint">增加一行</button>
            <button class="btn primary" type="submit">保存到数据库</button>
            <button class="btn" @onclick="ComputeFits">拟合并显示</button>
        </div>
    </section>
    @if (HasFit)
    {
        <section class="fit-results">
            <h4>拟合曲线</h4>
            <div style="width:700px;height:380px;">
                <MotorPlot Torques="@(EditingPoints.Select(p => p.Torque).ToArray())"
                    Speeds="@(EditingPoints.Select(p => p.Speed).ToArray())"
                    Currents="@(EditingPoints.Select(p => p.Current).ToArray())"
                    Title="@(EditingMotor?.MotorName ?? "Motor")" />
            </div>
            <h5>关键点</h5>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>空载转速 (rpm)</th>
                        <th>堵转扭矩 (Nm)</th>
                        <th>空载电流 (A)</th>
                        <th>堵转电流 (A)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>@NoLoadSpeed.ToString("F1")</td>
                        <td>@StallTorque.ToString("F3")</td>
                        <td>@NoLoadCurrent.ToString("F3")</td>
                        <td>@StallCurrent.ToString("F3")</td>
                    </tr>
                </tbody>
            </table>
        </section>
    }
</div>